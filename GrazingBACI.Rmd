---
title: "Begrazing Schapen Analyse"
author: "Femke Batsleer"
date: "8 April 2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggsci)
library(effects)
library(afex)
library(lme4)
library(sjPlot)
```

# Read data

```{r}
#read data
rd <- read.csv(file="data_grazing_BACI.csv", header=T, sep=";")

#rename data and get in right format
rd_tidy <- rd %>%
  mutate(Site = ifelse(Site=="Cabour", "Site1",
                       ifelse(Site=="Controle thesis", "Control", "Site2"))) %>%
  rename(Timepoint=Meetpunt, Year=Jaar) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(Year=as.factor(Year))

rd_tidy$Datum <- factor(rd_tidy$Datum, levels=unique(rd$Datum))
rd_tidy$Date <- as.Date(rd_tidy$Datum, format="%d/%m/%Y")

rd_tidy <- rd_tidy %>% 
  rename(nClosedNests = Aantal.toe,
         nOpenNests = Aantal.open)
rd_tidy <- rd_tidy %>% mutate(PlotUnique = paste0(Site, as.character(Plot)))

head(rd_tidy)
summary(rd_tidy)
nrow(rd_tidy)
```

# Statistical model

```{r}
#running statistical model
model_closed <- glmer.nb(nClosedNests ~ Year +
                           Site +
                           Year:Site +
                           (1 | PlotUnique) +
                           (1 | Timepoint),
                    data = rd_tidy,
                    control = glmerControl(optimizer = "bobyqa",
                    optCtrl = list(maxfun = 2e5)))
summary(model_closed)

plot_model(model_closed,
           type = "pred",
           terms = c("Year", "Site"),
           dot.size = 3,
           line.size = 1) +
  xlab("Site") +
  ylab("Number of nests") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 25,
                                  face = "bold"),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20), 
        panel.background = element_rect(fill = "white",
                                        colour = "grey",
                                        size = 1,
                                        linetype = "solid"), 
        panel.grid.major = element_line(size = 0.5,
                                        linetype = "solid",
                                        colour = "grey")) +
  scale_colour_jco()


plot_model(model_closed,
           type = "pred",
           terms = c("Site", "Year"),
           dot.size = 3,
           line.size = 1) +
  xlab("Site") +
  ylab("Number of nests") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 25,
                                  face = "bold"),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20), 
        panel.background = element_rect(fill = "white",
                                        colour = "grey",
                                        size = 1,
                                        linetype = "solid"), 
        panel.grid.major = element_line(size = 0.5,
                                        linetype = "solid",
                                        colour = "grey")) +
  scale_colour_jco()
```

# Plots

To plot the graphs, the average over the different plots is taken (random effect in model)

```{r}
#Summarize to get average over plots per level of grazing 
rd_tidy_summary <- rd_tidy %>% ungroup() %>%
  # mutate(Site=recode_factor(Site, "Controle thesis"="Controle",
  #                           "Cabour" = "Extensief",
  #                           "Westhoek Zuid" = "Stoot")) %>%
  group_by(Year, Site) %>%
  summarise(avg.closed = mean(nClosedNests), sd.closed = sd(nClosedNests),
            avg.open = mean(nOpenNests), sd.open = sd(nOpenNests),
            n=n()) %>%
  mutate(se.closed=sd.closed/sqrt(n),
         se.open = sd.open/sqrt(n))


barplot_closed_year <- ggplot(rd_tidy_summary, aes(x=Year, y=avg.closed, fill=Site))+
  geom_bar(stat="identity", position=position_dodge())+
  geom_errorbar(aes(ymin=avg.closed-se.closed, ymax=avg.closed+se.closed), width=.2, position=position_dodge(0.9))+ 
  scale_linetype_manual(values=c("Control"=2, "Site1"=1, "Site2"=1))+
  scale_fill_brewer(palette="Blues")+
  theme_bw()+
  theme(text=element_text(size=16))+
  #ggtitle("Closed nests (reproduction)") +
  ylab("Amount closed nests")+xlab("Year") +
  guides(fill=guide_legend(title="Site"), linetype=guide_legend(title="Site"))
barplot_closed_year
```

